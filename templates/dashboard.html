<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tuition ERP | Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <style>
        :root { --primary: #4f46e5; --secondary: #64748b; --dark: #0f172a; --light: #f1f5f9; --white: #ffffff; --danger: #ef4444; --success: #22c55e; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--light); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--dark); color: #cbd5e1; display: flex; flex-direction: column; flex-shrink: 0;}
        .brand { padding: 25px; font-size: 1.4rem; font-weight: bold; color: var(--white); border-bottom: 1px solid #1e293b; display: flex; gap: 10px; align-items: center;}
        .menu { flex: 1; padding: 20px 10px; overflow-y: auto; }
        .menu-item { padding: 12px 15px; margin-bottom: 5px; cursor: pointer; display: flex; gap: 12px; border-radius: 6px; transition: 0.2s; color: #94a3b8; text-decoration: none; align-items: center; }
        .menu-item:hover, .menu-item.active { background: #1e293b; color: var(--white); }
        .menu-item.active { background: var(--primary); }
        
        /* Main Area */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .topbar { background: var(--white); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
        .content { padding: 30px; overflow-y: auto; height: 100%; }

        /* Components */
        .card { background: var(--white); padding: 25px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .btn { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0 20px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        label { font-weight: 600; color: var(--secondary); font-size: 0.9rem; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        th { background: #f8fafc; font-weight: 600; color: var(--secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:hover { background: #f8fafc; }
        
        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; gap: 20px; }
        .flex-1 { flex: 1; }
        .tag { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .tag-blue { background: #dbeafe; color: #1e40af; }
        .tag-green { background: #d1fae5; color: #065f46; }
        .val-large { font-size: 2rem; font-weight: bold; color: var(--dark); margin-top: 5px; }
    </style>
</head>
<body>

    <div id="login-screen" style="position:fixed; inset:0; background:var(--light); display:flex; justify-content:center; align-items:center; z-index:1000;">
        <div class="card" style="width:350px; text-align:center;">
            <h2 style="color:var(--primary); margin-bottom: 20px;"><i class="fa-solid fa-graduation-cap"></i> Tuition ERP</h2>
            <input type="text" id="user_in" placeholder="Username" />
            <input type="password" id="pass_in" placeholder="Password" />
            <button onclick="login()" class="btn" style="width:100%;">Sign In</button>
            <p id="login-error" style="color:var(--danger); font-size:0.9rem; margin-top:10px;" class="hidden"></p>
        </div>
    </div>

    <div id="app-screen" class="hidden" style="display:flex; width:100%; height:100%;">
        <div class="sidebar">
            <div class="brand"><i class="fa-solid fa-layer-group"></i> <span id="org-name">Tuition ERP</span></div>
            <div class="menu" id="sidebar-menu">
                </div>
            <div style="padding: 20px; border-top: 1px solid #1e293b;">
                <div style="font-size: 0.8rem; color: #64748b;">Logged in as</div>
                <div id="user-display" style="font-weight: bold; color: white;">User</div>
            </div>
        </div>
        
        <div class="main">
            <div class="topbar">
                <h3 id="page-title" style="margin:0; color:var(--dark);">Dashboard</h3>
                <button onclick="logout()" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem;">Logout</button>
            </div>
            <div class="content" id="main-content">
                </div>
        </div>
    </div>

    <script>
        // Use relative path so it automatically works for any tenant (e.g., galaxy.localhost/api)
        const API = "/api";
        let CURRENT_ROLE = "";

        // --- AUTHENTICATION ---
        if(localStorage.getItem('token')) initApp();

        async function login() {
            const u = document.getElementById('user_in').value;
            const p = document.getElementById('pass_in').value;
            const err = document.getElementById('login-error');
            
            try {
                const res = await fetch(`${API}/auth/login/`, {
                    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p})
                });
                if(res.ok) {
                    const data = await res.json();
                    localStorage.setItem('token', data.access);
                    initApp();
                } else {
                    err.innerText = "Invalid credentials";
                    err.classList.remove('hidden');
                }
            } catch(e) { err.innerText = "Server connection failed"; err.classList.remove('hidden'); }
        }

        function logout() { localStorage.removeItem('token'); location.reload(); }

        async function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            loadPage('dashboard');
        }

        async function apiCall(endpoint, method='GET', body=null) {
            const token = localStorage.getItem('token');
            const opts = {
                method,
                headers: { 'Authorization': `Bearer ${token}` }
            };
            // Only add JSON content-type if body is present AND it's not FormData (File Uploads)
            if (body && !(body instanceof FormData)) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(body);
            } else if (body instanceof FormData) {
                opts.body = body; // Let browser set Content-Type for FormData
            }
            
            const res = await fetch(`${API}${endpoint}`, opts);
            if(res.status === 401) logout();
            return res;
        }

        // --- NAVIGATION & PAGES ---
        async function loadPage(pageName) {
            const content = document.getElementById('main-content');
            const title = document.getElementById('page-title');
            
            // Highlight Menu
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            const btn = document.getElementById(`btn-${pageName}`);
            if(btn) btn.classList.add('active');

            try {
                // --- DASHBOARD (HOME) ---
                if (pageName === 'dashboard') {
                    title.innerText = 'Overview';
                    const res = await apiCall('/dashboard/stats/');
                    const data = await res.json();
                    
                    if(!document.getElementById('sidebar-menu').innerHTML.trim()) buildSidebar(data.role);
                    CURRENT_ROLE = data.role;
                    document.getElementById('user-display').innerText = data.username;
                    // Update Brand Name if Institute Name is available (can be added to stats API)
                    // document.getElementById('org-name').innerText = data.institute_name || "Tuition ERP";

                    let html = `<div class="grid">`;
                    data.widgets.forEach(w => {
                        html += `<div class="card" style="border-left: 4px solid ${w.color}">
                                    <div style="color:var(--secondary); font-size:0.9rem;">${w.label}</div>
                                    <div class="val-large" style="color:${w.color}">${w.value}</div>
                                 </div>`;
                    });
                    html += `</div>`;

                    if(data.table_data && data.table_data.length > 0) {
                        html += `<h3>${data.table_title}</h3><table><thead><tr>`;
                        Object.keys(data.table_data[0]).forEach(k => html += `<th>${k}</th>`);
                        html += `</tr></thead><tbody>`;
                        data.table_data.forEach(row => {
                            html += `<tr>`;
                            Object.values(row).forEach(v => html += `<td>${v}</td>`);
                            html += `</tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                    content.innerHTML = html;
                }

                // --- DIGITAL LIBRARY (FILES) ---
                else if (pageName === 'library') {
                    title.innerText = 'Digital Library';
                    const res = await apiCall('/academics/materials/');
                    const data = await res.json();
                    
                    let html = '';

                    // Upload Form (Only for Admins/Teachers)
                    if (CURRENT_ROLE === 'INSTITUTE_ADMIN' || CURRENT_ROLE === 'TEACHER') {
                        const batchRes = await apiCall('/academics/batches/');
                        const batches = await batchRes.json();
                        let options = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

                        html += `
                        <div class="card">
                            <h3><i class="fa-solid fa-cloud-arrow-up"></i> Upload New Material</h3>
                            <input type="text" id="mat_title" placeholder="Title (e.g. Physics Notes)">
                            <select id="mat_batch">${options}</select>
                            <input type="file" id="mat_file" style="border:none; padding-left:0; margin-top:10px;">
                            <button class="btn" onclick="uploadMaterial()">Upload PDF</button>
                        </div>`;
                    }

                    html += `<div class="grid">`;
                    if(data.length === 0) html += `<p>No study materials found.</p>`;
                    data.forEach(m => {
                        html += `
                            <div class="card">
                                <div style="font-weight:bold; font-size:1.1rem; color:var(--dark);">${m.title}</div>
                                <div style="color:#64748b; font-size:0.9rem; margin-bottom:15px;">For: ${m.batch_name}</div>
                                <a href="${m.file}" target="_blank" class="btn" style="background:#0f172a; text-decoration:none; font-size:0.8rem;">
                                    <i class="fa-solid fa-download"></i> Download
                                </a>
                            </div>`;
                    });
                    html += `</div>`;
                    content.innerHTML = html;
                }

                // --- MY FEES (STUDENT PAYMENT) ---
                else if (pageName === 'my_fees') {
                    title.innerText = 'My Fees';
                    const res = await apiCall('/finance/installments/'); // Requires backend to filter by user
                    const data = await res.json();

                    let html = `<div class="grid">`;
                    if(data.length === 0) html += `<p>No fee records found.</p>`;
                    data.forEach(inst => {
                        let action = `<span class="tag tag-green">PAID</span>`;
                        if(inst.status !== 'PAID') {
                            // "Pay Now" Button triggers Razorpay
                            action = `<button class="btn" onclick="startPayment(${inst.id})">Pay Now</button>`;
                        }

                        html += `
                            <div class="card">
                                <h3>${inst.fee_name}</h3>
                                <div style="font-size:1.5rem; margin:10px 0; font-weight:bold;">â‚¹ ${inst.amount_due}</div>
                                <div style="color:#64748b;">Due Date: ${inst.due_date}</div>
                                <div style="margin-top:15px;">${action}</div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                    content.innerHTML = html;
                }

                // --- STUDENTS MANAGEMENT ---
                else if (pageName === 'students') {
                    title.innerText = 'Student Management';
                    content.innerHTML = `
                        <div class="flex">
                            <div class="flex-1">
                                <div class="card">
                                    <h3><i class="fa-solid fa-user-plus"></i> New Admission</h3>
                                    <label>Full Name</label>
                                    <div class="flex">
                                        <input type="text" id="st_fname" placeholder="First Name">
                                        <input type="text" id="st_lname" placeholder="Last Name">
                                    </div>
                                    <label>Login Details</label>
                                    <div class="flex">
                                        <input type="text" id="st_user" placeholder="Username (Unique)">
                                        <input type="password" id="st_pass" placeholder="Password">
                                    </div>
                                    <label>Academic Info</label>
                                    <input type="text" id="st_enroll" placeholder="Enrollment No (e.g. 2026-001)">
                                    <button class="btn" onclick="submitStudent()">Admit Student</button>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3>Student Directory</h3>
                                <div id="student-list">Loading...</div>
                            </div>
                        </div>
                    `;
                    refreshStudentList();
                }
                
                // --- GENERIC TABLE VIEW (Institutes, Users) ---
                else {
                    title.innerText = pageName.charAt(0).toUpperCase() + pageName.slice(1);
                    const endpoint = pageName === 'institutes' ? '/institutes/' : `/${pageName}/`; // Adjust path logic
                    const res = await apiCall(endpoint);
                    if(!res.ok) throw new Error("Could not load data");
                    const data = await res.json();
                    
                    let html = '<table><thead><tr>';
                    if(data.length > 0) {
                        Object.keys(data[0]).forEach(k => html += `<th>${k}</th>`);
                        html += '</tr></thead><tbody>';
                        data.forEach(row => {
                            html += '<tr>';
                            Object.values(row).forEach(v => html += `<td>${v}</td>`);
                            html += '</tr>';
                        });
                        html += '</tbody></table>';
                    } else {
                        html = '<p>No data found.</p>';
                    }
                    content.innerHTML = html;
                }

            } catch(e) { console.error(e); content.innerHTML = `<div class="card" style="color:red">Error loading page: ${e.message}</div>`; }
        }

        // --- SIDEBAR BUILDER ---
        function buildSidebar(role) {
            const r = role.toUpperCase();
            const menu = document.getElementById('sidebar-menu');
            let items = `<div class="menu-item active" id="btn-dashboard" onclick="loadPage('dashboard')"><i class="fa-solid fa-chart-pie"></i> Overview</div>`;
            
            if(r === 'SUPER_ADMIN') {
                items += `<div class="menu-item" id="btn-institutes" onclick="loadPage('institutes')"><i class="fa-solid fa-building"></i> Institutes</div>`;
                items += `<div class="menu-item" id="btn-users" onclick="loadPage('users')"><i class="fa-solid fa-users"></i> Users</div>`;
            }
            if(r === 'INSTITUTE_ADMIN') {
                items += `<div class="menu-item" id="btn-students" onclick="loadPage('students')"><i class="fa-solid fa-user-graduate"></i> Students</div>`;
                items += `<div class="menu-item" id="btn-finance" onclick="loadPage('finance')"><i class="fa-solid fa-coins"></i> Finance</div>`;
                items += `<div class="menu-item" id="btn-library" onclick="loadPage('library')"><i class="fa-solid fa-book-open"></i> Digital Library</div>`;
            }
            if(r === 'TEACHER') {
                items += `<div class="menu-item" id="btn-attendance" onclick="loadPage('attendance')"><i class="fa-solid fa-clipboard-check"></i> Attendance</div>`;
                items += `<div class="menu-item" id="btn-library" onclick="loadPage('library')"><i class="fa-solid fa-book-open"></i> Digital Library</div>`;
            }
            if(r === 'STUDENT') {
                items += `<div class="menu-item" id="btn-library" onclick="loadPage('library')"><i class="fa-solid fa-book-open"></i> Digital Library</div>`;
                items += `<div class="menu-item" id="btn-my_fees" onclick="loadPage('my_fees')"><i class="fa-solid fa-credit-card"></i> My Fees</div>`;
                items += `<div class="menu-item" id="btn-results" onclick="loadPage('results')"><i class="fa-solid fa-square-poll-vertical"></i> Results</div>`;
            }
            menu.innerHTML = items;
        }

        // --- ACTION HANDLERS ---

        // 1. Upload Material
        async function uploadMaterial() {
            const fileInput = document.getElementById('mat_file');
            if(fileInput.files.length === 0) return alert("Select a file");

            const formData = new FormData();
            formData.append('title', document.getElementById('mat_title').value);
            formData.append('batch', document.getElementById('mat_batch').value);
            formData.append('file', fileInput.files[0]);

            try {
                // apiCall handles FormData correctly automatically
                const res = await apiCall('/academics/materials/', 'POST', formData);
                if(res.ok) { alert("Uploaded Successfully!"); loadPage('library'); }
                else { alert("Upload Failed"); }
            } catch(e) { console.error(e); }
        }

        // 2. Razorpay Payment
        async function startPayment(installmentId) {
            try {
                // Step A: Create Order
                const res = await apiCall('/finance/pay/initiate/', 'POST', { installment_id: installmentId });
                const orderData = await res.json();
                if(!res.ok) throw new Error(orderData.error || "Order Creation Failed");

                // Step B: Open Popup
                var options = {
                    "key": orderData.key_id, 
                    "amount": orderData.amount, 
                    "currency": orderData.currency,
                    "name": "Tuition ERP",
                    "description": "Fee Payment",
                    "order_id": orderData.order_id, 
                    "handler": async function (response){
                        // Step C: Verify
                        const verifyRes = await apiCall('/finance/pay/verify/', 'POST', {
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature,
                            installment_id: orderData.installment_id,
                            amount: orderData.amount
                        });
                        const result = await verifyRes.json();
                        if(result.status === 'success') {
                            alert("Payment Successful!");
                            loadPage('my_fees');
                        } else {
                            alert("Verification Failed");
                        }
                    },
                    "theme": { "color": "#4f46e5" }
                };
                var rzp1 = new Razorpay(options);
                rzp1.open();
            } catch (e) { alert(e.message); }
        }

        // 3. Student Admission
        async function refreshStudentList() {
            try {
                const res = await apiCall('/academics/students/');
                const data = await res.json();
                let html = `<table><thead><tr><th>Name</th><th>Enrollment</th></tr></thead><tbody>`;
                data.forEach(s => html += `<tr><td>${s.user.username}</td><td>${s.enrollment_number}</td></tr>`);
                html += `</tbody></table>`;
                document.getElementById('student-list').innerHTML = html;
            } catch { document.getElementById('student-list').innerHTML = "Error fetching list"; }
        }

        async function submitStudent() {
            const payload = {
                username: document.getElementById('st_user').value,
                password: document.getElementById('st_pass').value,
                first_name: document.getElementById('st_fname').value,
                last_name: document.getElementById('st_lname').value,
                email: `${document.getElementById('st_user').value}@example.com`,
                profile: {
                    enrollment_number: document.getElementById('st_enroll').value,
                    parent_name: "Unknown",
                    parent_phone: "0000000000"
                }
            };
            try {
                const res = await apiCall('/academics/students/', 'POST', payload);
                if(res.ok) { alert("Student Admitted!"); loadPage('students'); } 
                else { const err = await res.json(); alert("Error: " + JSON.stringify(err)); }
            } catch(e) { alert("Network Error"); }
        }

    </script>
</body>
</html>